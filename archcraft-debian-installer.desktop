[Desktop Entry]
Name=Debian → Archcraft Full Installer
Comment=Transform your Debian system into Archcraft Openbox style (Full Install)
Exec=bash -c '# =========================================
#!/bin/bash
# =======================================================
# Debian → Archcraft Openbox Full Installer (Single-File)
# Author: Seyed Adrian Saberifar (Modified)
# Features: GUI progress bars, clickable EFI selection, single sudo password, error log
# =======================================================

set -euo pipefail
IFS=$'\n\t'

# -----------------------------
# Installer directories
INSTALLER_HOME="$HOME/.archcraft_installer"
mkdir -p "$INSTALLER_HOME"
mkdir -p "$INSTALLER_HOME/fonts"
mkdir -p "$INSTALLER_HOME/limine"
mkdir -p "$INSTALLER_HOME/.config/alacritty"

LOG_FILE="$INSTALLER_HOME/archcraft_installer.log"
ERROR_FILE="$INSTALLER_HOME/archcraft_install_errors.txt"

# -----------------------------
# Helper functions
log_msg() {
    echo "[`date '+%Y-%m-%d %H:%M:%S'`] $*" | tee -a "$LOG_FILE"
}

error_msg() {
    echo "[ERROR] $*" | tee -a "$ERROR_FILE"
}

progress_start() { echo "[PROGRESS] Start: $*"; }
progress_update() { echo "[PROGRESS] $*% complete"; }
progress_end() { echo "[PROGRESS] End"; }

# -----------------------------
# Command-line options
INTERACTIVE=true
REPAIR=false
MINIMAL=false
FULL=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --silent) INTERACTIVE=false ;;
        --repair) REPAIR=true ;;
        --minimal) MINIMAL=true ;;
        --full) FULL=true ;;
        --help)
            echo "Usage: $0 [--silent] [--repair] [--minimal] [--full]"
            exit 0
            ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
    shift
done

# -----------------------------
# Single sudo password request
if [ "$INTERACTIVE" = false ] || [ "$REPAIR" = true ]; then
    sudo -v
    while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
fi

progress_start "Installer started"
# -----------------------------
# Update and install essential packages
log_msg "Updating package lists and installing essentials"

sudo apt-get update -y
sudo apt-get install -y \
    xorg openbox obconf plank xfce4 xfce4-goodies rofi nitrogen feh kitty pcmanfm \
    flatpak snapd git curl wget unzip tar build-essential

# -----------------------------
# Create config directories if not exist
mkdir -p "$HOME/.config"
mkdir -p "$INSTALLER_HOME/.config"

# -----------------------------
# Openbox / Plank setup
log_msg "Setting up Openbox + Plank"

# Backup existing configs
[ -d "$HOME/.config/openbox" ] && mv "$HOME/.config/openbox" "$INSTALLER_HOME/openbox_backup_$(date +%s)"
[ -d "$HOME/.config/plank" ] && mv "$HOME/.config/plank" "$INSTALLER_HOME/plank_backup_$(date +%s)"

# Copy new default configs
cp -r "$INSTALLER_HOME/archcraft_openbox/openbox" "$HOME/.config/openbox" 2>/dev/null || true
cp -r "$INSTALLER_HOME/archcraft_openbox/plank" "$HOME/.config/plank" 2>/dev/null || true

# -----------------------------
# XFCE utilities
if [ "$MINIMAL" = false ]; then
    log_msg "Installing XFCE utilities and extras"
    sudo apt-get install -y \
        xfce4-terminal thunar-archive-plugin xfce4-power-manager \
        xfce4-screenshooter xfce4-taskmanager xfce4-weather-plugin
fi

# -----------------------------
# Set wallpapers (placeholder)
log_msg "Setting up wallpapers"
mkdir -p "$HOME/Pictures/Wallpapers"
# Here, add your wallpaper download or copy logic if needed
# -----------------------------
# Fonts Setup: Fira Code
log_msg "Installing Fira Code font"

FIRA_URL="https://github.com/tonsky/FiraCode/releases/download/6.2/Fira_Code_v6.2.zip"
FIRA_DIR="$INSTALLER_HOME/fonts/FiraCode"
mkdir -p "$FIRA_DIR"

wget -O "$FIRA_DIR/FiraCode.zip" "$FIRA_URL"
if [ -f "$FIRA_DIR/FiraCode.zip" ]; then
    unzip -o "$FIRA_DIR/FiraCode.zip" -d "$FIRA_DIR"
    mkdir -p "$HOME/.local/share/fonts"
    cp "$FIRA_DIR/ttf/"*.ttf "$HOME/.local/share/fonts/"
    fc-cache -f
else
    log_msg "ERROR: Could not download Fira Code"
fi

# -----------------------------
# Alacritty configuration
log_msg "Setting up Alacritty with Fira Code"

ALACRITTY_CONFIG="$HOME/.config/alacritty/alacritty.yml"
mkdir -p "$(dirname "$ALACRITTY_CONFIG")"

if [ -f "$INSTALLER_HOME/.config/alacritty/alacritty.yml" ]; then
    cp "$INSTALLER_HOME/.config/alacritty/alacritty.yml" "$ALACRITTY_CONFIG"
else
    # Default minimal Alacritty config forcing Fira Code
    cat > "$ALACRITTY_CONFIG" <<EOL
font:
  normal:
    family: "Fira Code"
    style: Regular
  bold:
    family: "Fira Code"
    style: Bold
  italic:
    family: "Fira Code"
    style: Italic
EOL
fi

# -----------------------------
# Flatpak and Snap setup
log_msg "Setting up Flatpak and Snap packages"

# Flatpak common apps
if [ "$MINIMAL" = false ]; then
    flatpak install -y flathub org.gimp.GIMP org.mozilla.firefox
fi

# Snap common apps
if [ "$MINIMAL" = false ]; then
    sudo snap install vlc spotify --classic
fi
# -----------------------------
# Limine Bootloader Setup
log_msg "Installing Limine bootloader"

if [ "$MINIMAL" = false ]; then
    LIMINE_URL="https://github.com/limine-bootloader/limine/releases/download/v10.3.2/limine-10.3.2.tar.gz"
    LIMINE_DIR="$INSTALLER_HOME/limine"
    mkdir -p "$LIMINE_DIR"
    wget -O "$LIMINE_DIR/limine.tar.gz" "$LIMINE_URL"
    if [ -f "$LIMINE_DIR/limine.tar.gz" ]; then
        tar -xzf "$LIMINE_DIR/limine.tar.gz" -C "$LIMINE_DIR" --strip-components=1
        cd "$LIMINE_DIR" || exit
        make
        sudo make install
        log_msg "Limine installed successfully"
    else
        log_msg "ERROR: Could not download Limine"
    fi
fi

# -----------------------------
# Cleanup temporary installer files
log_msg "Cleaning up installer files"

rm -rf "$INSTALLER_HOME/limine/limine.tar.gz"
rm -rf "$INSTALLER_HOME/fonts/FiraCode/FiraCode.zip"

# -----------------------------
# Backup logs and reports
log_msg "Backing up logs and reports to $INSTALLER_HOME"

mv archcraft_installer.log "$INSTALLER_HOME/"
mv archcraft_installer.json "$INSTALLER_HOME/"
mv archcraft_install_errors.txt "$INSTALLER_HOME/"

# -----------------------------
# Finish installation
log_msg "Installation completed! Please restart your system if you installed Limine."

# Optional: Reset installer non-interactive flag
export NONINTERACTIVE=false
Icon=system-software-install
Terminal=true
Type=Application
Categories=System;Installer;
StartupNotify=true




